---
import { debts, debtHelpers } from '../lib/debts';
import type { Debt } from '../lib/debts';
---

<div class="bg-slate-800 rounded-lg p-4 border border-slate-700">
  <h3 class="font-semibold text-white mb-4">Debts Overview</h3>

  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <div class="text-center">
      <p class="text-2xl font-bold text-green-400">${debtHelpers.formatAmount(summary?.total_owed || 0)}</p>
      <p class="text-xs text-slate-400">Owed to You</p>
    </div>
    <div class="text-center">
      <p class="text-2xl font-bold text-red-400">${debtHelpers.formatAmount(summary?.total_i_owe || 0)}</p>
      <p class="text-xs text-slate-400">You Owe</p>
    </div>
    <div class="text-center">
      <p class="text-2xl font-bold ${summary?.net_balance >= 0 ? 'text-green-400' : 'text-red-400'}">
        ${debtHelpers.formatRelative(summary?.net_balance || 0)}
      </p>
      <p class="text-xs text-slate-400">Net Balance</p>
    </div>
    <div class="text-center">
      <p class="text-2xl font-bold text-vig-400">${(summary?.count_owed || 0) + (summary?.count_i_owe || 0)}</p>
      <p class="text-xs text-slate-400">Total Debts</p>
    </div>
  </div>

  <div class="space-y-4">
    <!-- Debts I'm owed -->
    {owed_to_me.length > 0 && (
      <div>
        <h4 class="font-medium text-white mb-2 flex items-center">
          <svg class="w-4 h-4 mr-1 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          Owed to You ({owed_to_me.length})
        </h4>
        <div class="space-y-2 ml-6">
          {owed_to_me.map(debt => (
            <div class="bg-green-900/20 border border-green-800 rounded-lg p-3">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <p class="text-sm text-white">{debt.description || 'Unspecified debt'}</p>
                  <p class="text-xs text-green-400 mt-1">
                    From: {debtorName || 'Unknown'} • {debtHelpers.getAgeInDays(debt)} days old
                    {debtHelpers.isOverdue(debt) && ' ⚠️ Overdue'}
                  </p>
                </div>
                <div class="text-right ml-4">
                  <p class="text-sm font-bold text-white">{debtHelpers.formatAmount(debt.amount_cents)}</p>
                  <button
                    onclick="markAsPaid('${debt.id}')"
                    class="text-xs bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded mt-1"
                  >
                    Mark Paid
                  </button>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    )}

    <!-- Debts I owe -->
    {i_owe.length > 0 && (
      <div>
        <h4 class="font-medium text-white mb-2 flex items-center">
          <svg class="w-4 h-4 mr-1 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          You Owe ({i_owe.length})
        </h4>
        <div class="space-y-2 ml-6">
          {i_owe.map(debt => (
            <div class="bg-red-900/20 border border-red-800 rounded-lg p-3">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <p class="text-sm text-white">{debt.description || 'Unspecified debt'}</p>
                  <p class="text-xs text-red-400 mt-1">
                    To: {creditorName || 'Unknown'} • {debtHelpers.getAgeInDays(debt)} days old
                  </p>
                </div>
                <div class="text-right ml-4">
                  <p class="text-sm font-bold text-white">{debtHelpers.formatAmount(debt.amount_cents)}</p>
                  <button
                    onclick="markAsPaid('${debt.id}')"
                    class="text-xs bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded mt-1"
                  >
                    Mark Paid
                  </button>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    )}

    <!-- No debts -->
    {owed_to_me.length === 0 && i_owe.length === 0 && (
      <div class="text-center py-8 text-slate-500">
        <svg class="w-12 h-12 mx-auto mb-2 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <p>No outstanding debts</p>
        <p class="text-sm mt-1">You're all settled up!</p>
      </div>
    )}
  </div>

  <div class="mt-6 pt-4 border-t border-slate-700">
    <button
      onclick="showCreateDebtModal()"
      class="w-full bg-vig-600 hover:bg-vig-700 text-white font-medium py-2 px-4 rounded-lg transition-colors"
    >
      Add New Debt
    </button>
  </div>
</div>

<script>
  async function markAsPaid(debtId) {
    try {
      const response = await fetch('/api/debts', {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify({
          id: debtId,
          status: 'paid'
        })
      });

      if (response.ok) {
        // Refresh the page to show updated status
        location.reload();
      } else {
        const error = await response.json();
        alert(`Failed to mark debt as paid: ${error.error}`);
      }
    } catch (error) {
      alert('Failed to mark debt as paid');
    }
  }

  function showCreateDebtModal() {
    // This would show a modal to create a new debt
    alert('Debt creation feature coming soon!');
  }
</script>