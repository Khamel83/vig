---
import Layout from '../layouts/Layout.astro';
import { validateInvite, useInvite } from '@/lib/invites';
import { validateToken } from '@/lib/auth';
import type { Context } from 'astro';

interface InviteValidation {
  valid: boolean;
  event_id?: string;
  error?: string;
  expires_at?: number;
  uses_remaining?: number;
  event?: {
    id: string;
    name: string;
    description?: string;
    sport?: string;
  };
}

// Get invite code from URL
const inviteCodeFromUrl = Astro.url.searchParams.get('code');

// Check authentication
const token = Astro.cookies.get('vig_session')?.value;
let currentUser = null;
if (token) {
  currentUser = await validateToken(
    Astro.locals.runtime.env.DB,
    Astro.locals.runtime.env.JWT_SECRET || '',
    token
  );
}

// Validate invite code server-side
let inviteValidation: InviteValidation | null = null;
if (inviteCodeFromUrl) {
  const result = await validateInvite(Astro.locals.runtime.env.DB, inviteCodeFromUrl);
  inviteValidation = result;

  // If valid and we have event_id, fetch event details
  if (result.valid && result.event_id) {
    const eventStmt = await Astro.locals.runtime.env.DB.prepare(
      'SELECT id, name, description, sport FROM events WHERE id = ?'
    ).bind(result.event_id);
    const event = await eventStmt.first();

    if (event) {
      inviteValidation = {
        ...result,
        event: {
          id: event.id as string,
          name: event.name as string,
          description: event.description as string | undefined,
          sport: event.sport as string | undefined,
        },
      };
    }
  }
}

// Handle join action
let joinSuccess = false;
let joinError = '';

if (Astro.request.method === 'POST' && currentUser && inviteCodeFromUrl) {
  const formData = await Astro.request.formData();
  const action = formData.get('action');

  if (action === 'join') {
    const result = await useInvite(
      Astro.locals.runtime.env.DB,
      Astro.locals.runtime.env.KV,
      inviteCodeFromUrl,
      currentUser.id
    );

    if (result.success) {
      joinSuccess = true;
    } else {
      joinError = result.error || 'Failed to join pool';
    }
  }
}
---

<Layout title="Join Pool">
  <div class="min-h-screen bg-slate-900 text-white flex items-center justify-center">
    <div class="container mx-auto px-4 max-w-md w-full">
      <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
        {joinSuccess ? (
          <div class="space-y-6 text-center">
            <div class="text-green-400 text-6xl mb-4">âœ“</div>
            <h1 class="text-2xl font-bold mb-2">Successfully Joined!</h1>
            <p class="text-slate-400">
              You've joined the pool. You can now access it from your dashboard.
            </p>
            <a
              href="/dashboard"
              class="inline-block bg-vig-600 hover:bg-vig-700 text-white font-medium py-3 px-6 rounded-lg transition-colors"
            >
              Go to Dashboard
            </a>
          </div>
        ) : inviteValidation?.event && currentUser ? (
          <div class="space-y-6">
            <div class="text-center">
              <h1 class="text-2xl font-bold mb-2">Join Pool</h1>
              <p class="text-slate-400">
                You've been invited to join:
              </p>
            </div>

            <div class="bg-slate-700 rounded-lg p-4">
              <h2 class="text-xl font-bold text-vig-400 mb-2">
                {inviteValidation.event.name}
              </h2>
              {inviteValidation.event.description && (
                <p class="text-slate-300 text-sm mb-2">
                  {inviteValidation.event.description}
                </p>
              )}
              {inviteValidation.event.sport && (
                <p class="text-slate-400 text-sm">
                  Sport: {inviteValidation.event.sport.toUpperCase()}
                </p>
              )}
            </div>

            <div class="bg-slate-700 rounded-lg p-4 text-center">
              <p class="text-sm text-slate-400 mb-1">Invitation Code</p>
              <p class="text-2xl font-mono font-bold text-vig-400 mb-2">
                {inviteCodeFromUrl}
              </p>
              {inviteValidation.expires_at && (
                <p class="text-xs text-slate-500">
                  Expires: {new Date(inviteValidation.expires_at * 1000).toLocaleDateString()}
                </p>
              )}
              {inviteValidation.uses_remaining !== undefined && (
                <p class="text-xs text-slate-500">
                  {inviteValidation.uses_remaining} spot{inviteValidation.uses_remaining !== 1 ? 's' : ''} remaining
                </p>
              )}
            </div>

            {joinError && (
              <div class="bg-red-900/20 border border-red-800 rounded-lg p-3">
                <p class="text-red-400 text-sm">{joinError}</p>
              </div>
            )}

            <form method="POST">
              <button
                type="submit"
                name="action"
                value="join"
                class="w-full bg-vig-600 hover:bg-vig-700 text-white font-medium py-3 px-4 rounded-lg transition-colors"
              >
                Join Pool
              </button>
            </form>
          </div>
        ) : inviteCodeFromUrl && !currentUser ? (
          <div class="space-y-6">
            <div class="text-center">
              <h1 class="text-2xl font-bold mb-2">Join Pool</h1>
              <p class="text-slate-400">
                You've been invited to join a pool. Sign in to continue.
              </p>
            </div>

            <div class="bg-slate-700 rounded-lg p-4 text-center">
              <p class="text-sm text-slate-400 mb-1">Invitation Code</p>
              <p class="text-3xl font-mono font-bold text-vig-400 mb-2">
                {inviteCodeFromUrl}
              </p>
              {inviteValidation?.expires_at && (
                <p class="text-sm text-slate-400">
                  This invitation code will expire on {new Date(inviteValidation.expires_at * 1000).toLocaleDateString()}
                </p>
              )}
            </div>

            {inviteValidation?.error && (
              <div class="bg-red-900/20 border border-red-800 rounded-lg p-3">
                <p class="text-red-400 text-sm">{inviteValidation.error}</p>
              </div>
            )}

            <div class="space-y-3">
              <a
                href={`/api/auth/google?invite_code=${encodeURIComponent(inviteCodeFromUrl)}`}
                class="block w-full bg-vig-600 hover:bg-vig-700 text-white font-medium py-3 px-4 rounded-lg transition-colors text-center"
              >
                Sign in with Google
              </a>

              <div class="text-center">
                <p class="text-sm text-slate-400">
                  Already have an account?
                  <a href="/login" class="text-vig-400 hover:underline ml-1">Sign in</a>
                </p>
              </div>
            </div>
          </div>
        ) : (
          <div class="space-y-6">
            <div class="text-center">
              <h1 class="text-2xl font-bold mb-2">Join a Pool</h1>
              <p class="text-slate-400">
                Enter your invitation code to join a pool
              </p>
            </div>

            <div class="space-y-3">
              <form action="" method="GET">
                <div>
                  <label for="invite-code" class="block text-sm font-medium mb-2">Invitation Code</label>
                  <input
                    type="text"
                    name="code"
                    id="invite-code"
                    placeholder="e.g., ABC-1234"
                    class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-vig-500 focus:border-transparent"
                    required
                  />
                </div>

                <button
                  type="submit"
                  class="w-full mt-4 bg-vig-600 hover:bg-vig-700 text-white font-medium py-3 px-4 rounded-lg transition-colors"
                >
                  Validate Code
                </button>
              </form>
            </div>

            <div class="text-center">
              <p class="text-sm text-slate-400">
                Need an invitation?
                <a href="/contact" class="text-vig-400 hover:underline ml-1">Contact the pool admin</a>
              </p>
            </div>
          </div>
        )}
      </div>
    </div>
  </div>
</Layout>
