---
import Layout from '../layouts/Layout.astro';
---

<Layout title="NBA 2026 Pool">
  <div id="nba26-container">
    <div class="animate-pulse">
      <div class="h-8 bg-slate-700 rounded w-1/3 mb-4"></div>
      <div class="h-4 bg-slate-700 rounded w-2/3 mb-8"></div>
      <div class="space-y-4">
        {Array(5).fill(0).map(() => (
          <div class="h-32 bg-slate-700 rounded"></div>
        ))}
      </div>
    </div>
  </div>
</Layout>

<script>
  interface EventData {
    event: {
      id: string;
      slug: string;
      name: string;
      description: string;
      sport: string;
      status: string;
      pool_type: string;
    };
    options: Array<{
      id: string;
      name: string;
      abbreviation: string;
    }>;
    selections: Array<{
      id: string;
      option_id: string;
      user_id: string;
      user_name: string;
    }>;
    standings: Array<{
      user_id: string;
      user_name: string;
      wins: number;
      losses: number;
      points: number;
      rank: number;
    }>;
  }

  interface OwnerStanding {
    user_id: string;
    user_name: string;
    teams: Array<{
      name: string;
      abbreviation: string;
      wins: number;
      losses: number;
    }>;
    total_wins: number;
    total_losses: number;
    rank: number;
  }

  const container = document.getElementById('nba26-container') as HTMLDivElement;

  async function loadNBA26() {
    try {
      const response = await fetch('/api/events/nba26');
      const data = await response.json() as EventData;

      if (!response.ok || !data.event) {
        container.innerHTML = `
          <div class="text-center py-12">
            <h1 class="text-2xl font-bold mb-2">Event Not Found</h1>
            <p class="text-slate-400">The NBA 2026 pool doesn't exist yet.</p>
            <a href="/" class="btn btn-primary mt-4 inline-block">Back to Home</a>
          </div>
        `;
        return;
      }

      renderLeaderboard(data);
    } catch (error) {
      console.error('Load error:', error);
      container.innerHTML = `
        <div class="text-center py-12">
          <h1 class="text-2xl font-bold mb-2">Error Loading Pool</h1>
          <p class="text-slate-400">Please try again later.</p>
          <a href="/" class="btn btn-primary mt-4 inline-block">Back to Home</a>
        </div>
      `;
    }
  }

  function renderLeaderboard(data: EventData) {
    // Create a map of option_id to option data
    const optionMap = new Map(data.options.map(o => [o.id, o]));

    // Group selections by owner
    const ownerMap = new Map<string, OwnerStanding>();

    for (const selection of data.selections) {
      const option = optionMap.get(selection.option_id);
      if (!option) continue;

      if (!ownerMap.has(selection.user_id)) {
        ownerMap.set(selection.user_id, {
          user_id: selection.user_id,
          user_name: selection.user_name,
          teams: [],
          total_wins: 0,
          total_losses: 0,
          rank: 0,
        });
      }

      const owner = ownerMap.get(selection.user_id)!;
      // Placeholder wins/losses - in production this would come from standings
      owner.teams.push({
        name: option.name,
        abbreviation: option.abbreviation || option.name.slice(0, 3).toUpperCase(),
        wins: 0,
        losses: 0,
      });
      owner.total_wins += 0;
      owner.total_losses += 0;
    }

    // Convert to array and rank by total wins (descending), then by total losses (ascending)
    const rankings = Array.from(ownerMap.values()).sort((a, b) => {
      if (b.total_wins !== a.total_wins) {
        return b.total_wins - a.total_wins;
      }
      return a.total_losses - b.total_losses;
    });

    // Assign ranks
    rankings.forEach((owner, index) => {
      owner.rank = index + 1;
    });

    // Render
    const medals = ['\u{1F947}', '\u{1F948}', '\u{1F949}']; // Gold, Silver, Bronze

    container.innerHTML = `
      <div class="space-y-8">
        <!-- Header -->
        <div>
          <div class="flex items-center gap-3 mb-2">
            <h1 class="text-3xl font-bold">${data.event.name}</h1>
            <span class="px-3 py-1 text-sm rounded bg-slate-600">Live Standings</span>
          </div>
          ${data.event.description ? `<p class="text-slate-400">${data.event.description}</p>` : ''}
        </div>

        <!-- Leaderboard -->
        <div class="space-y-4">
          ${rankings.map((owner) => `
            <div class="card ${owner.rank === 1 ? 'ring-2 ring-yellow-500/50 bg-yellow-900/10' : ''}">
              <div class="flex items-center justify-between p-4 border-b border-slate-700">
                <div class="flex items-center gap-3">
                  <span class="text-2xl w-8 text-center">${medals[owner.rank - 1] || owner.rank}</span>
                  <div>
                    <h3 class="text-xl font-bold">${owner.user_name}</h3>
                    <p class="text-sm text-slate-400">${owner.teams.length} team${owner.teams.length !== 1 ? 's' : ''}</p>
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-2xl font-bold">
                    <span class="text-vig-400">${owner.total_wins}</span>
                    <span class="text-slate-500 mx-1">-</span>
                    <span class="text-red-400">${owner.total_losses}</span>
                  </div>
                  <p class="text-xs text-slate-500">Win - Loss</p>
                </div>
              </div>
              <div class="p-4 grid grid-cols-1 sm:grid-cols-3 gap-3">
                ${owner.teams.map(team => `
                  <div class="bg-slate-700/50 rounded p-3 flex items-center justify-between">
                    <div>
                      <div class="font-bold">${team.abbreviation}</div>
                      <div class="text-xs text-slate-400 truncate max-w-[120px]">${team.name}</div>
                    </div>
                    <div class="text-right">
                      <div class="text-sm font-medium">
                        <span class="text-vig-400">${team.wins}</span> - <span class="text-red-400">${team.losses}</span>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `).join('')}
        </div>

        <!-- Footer note -->
        <p class="text-center text-sm text-slate-500">
          Standings update as games complete. Pick 3 teams, count their wins.
        </p>
      </div>
    `;
  }

  loadNBA26();
</script>
